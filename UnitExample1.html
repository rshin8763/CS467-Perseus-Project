<!DOCTYPE html>
<html>
<head>
        <!--<script src="//cdn.jsdelivr.net/npm/phaser@3.6.0/dist/phaser.js"></script> 
        <script src="//cdn.jsdelivr.net/npm/phaser-ce@2.10.3/build/phaser.js"></script> -->
        <script src="./js/phaser.min.js"></script>
</head>
<body>

    <script type="module">
        'use strict';
        import {Barracks} from './js/barracks.js';    
        import {Fort} from './js/fort.js';
        import {Navigator} from './js/navigator.js';
        let Perseus = {};
        Perseus.graphics = {}

        // create the game, and pass it the configuration
        Perseus.game = new Phaser.Game(800, 608, Phaser.AUTO, '', { preload: preload, create: create, update: update });

        function preload() {
            console.log("preload");
            
            Perseus.game.load.image('barracks', 'assets/barracks.png');
            Perseus.game.load.image('fort', 'assets/fort.png');
            Perseus.game.load.image('button', 'assets/button.png');
            Perseus.game.load.image('arrow', 'assets/arrow.png');
            Perseus.game.load.image('navSquare', 'assets/navSquare.png');




            Perseus.game.load.spritesheet('swordsman', 'assets/swordsman.png', 64, 64);
            Perseus.game.load.spritesheet('swordswoman', 'assets/swordswoman.png', 64, 64);
            Perseus.game.load.spritesheet('archer_male', 'assets/archer_male.png', 64, 64);
            Perseus.game.load.spritesheet('archer_female', 'assets/archer_female.png', 64, 64);
            Perseus.game.load.spritesheet('worker_male', 'assets/worker_male.png', 64, 64);
            Perseus.game.load.spritesheet('worker_female', 'assets/worker_female.png', 64, 64);


            };

        function create() {
            Perseus.navigator = new Navigator(Perseus.game, 25, 19, 32);
  
    
            Perseus.game.canvas.oncontextmenu = function (e) { e.preventDefault();return false;}   
            
            let barracks = new Barracks(0, 0, Perseus);
            let fort = new Fort(320, 320, Perseus);
            for(let i = 0; i < 4; i++)
            {
                for(let j = 0; j < 4; j++)
                {
                    Perseus.navigator.navmap[i + Math.floor(320/32)][j + Math.floor(320/32)] = 1;
                }
            }

            console.log(Perseus.navigator.navmap);

            Perseus.selectionCircles=[];
            Perseus.selected = fort;
            Perseus.objects = [];
            let button = {};
            button.button = true;
            button.update = () =>{};
            button.movable = false;
            button.sprite = Perseus.game.add.sprite(200, 500, 'button');
            button.sprite.inputEnabled = true;
            button.sprite.events.onInputDown.add(function(){
            if(!Perseus.selected.movable)
            {  
                if(Perseus.selected.type == "Barracks")
                {
                    Perseus.selected.buildSoldier();
                }

                if(Perseus.selected.type == "Fort")
                {
                    Perseus.selected.buildWorker();
                }
            } else {
                if(Perseus.selected.type == "Worker")
                {
                    Perseus.selected.build(100, 100, "Fort");
                }
            }
        }, Perseus.game);
           
            Perseus.objects.push(button);

            Perseus.objects.push(barracks);

            Perseus.objects.push(fort);

            Perseus.game.input.mouse.capture = true;
        }


        function update(){

            if(Perseus.game.input.activePointer.leftButton.isDown)
            {   
                //console.log(game.input.activePointer.x + "," + game.input.activePointer.y + " " + Perseus.game.getSquare(game.input.activePointer.x, game.input.activePointer.y));
                Perseus.navigator.getSquare(Perseus.game.input.activePointer.x, Perseus.game.input.activePointer.y);
                if(Perseus.selected.movable)
                    {
                        if(Math.abs(Perseus.game.input.activePointer.x - Perseus.selected.sprite.x) > 64 || Math.abs(Perseus.game.input.activePointer.y - Perseus.selected.sprite.y)  > 64)
                        {
                            if(Perseus.selected.placing == true)
                            {
                                console.log("Placing!");
                                Perseus.selected.place(Perseus.game.input.x - 64, Perseus.game.input.y -64);
                                return; 
                            }
                            //Perseus.game.navigator.findNextNode(Perseus.game.selected ,Perseus.game.navigator.getSquare(game.input.activePointer.x, game.input.activePointer.y));
                            Perseus.selected.move(Perseus.game.input.activePointer.x, Perseus.game.input.activePointer.y);
                        } 

                    }
                

            }
            Perseus.objects.forEach(function(object){
                object.update();
            });
        }




  
    </script>

</body>
</html>