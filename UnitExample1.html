<!DOCTYPE html>
<html>
<head>
        <!--<script src="//cdn.jsdelivr.net/npm/phaser@3.6.0/dist/phaser.js"></script> 
        <script src="//cdn.jsdelivr.net/npm/phaser-ce@2.10.3/build/phaser.js"></script> -->
        <script src="./js/phaser.min.js"></script>
</head>
<body>

    <script type="module">
        'use strict';
        import {Barracks} from './js/barracks.js';    
        import {Fort} from './js/fort.js';
        import {Navigator} from './js/navigator.js';

        // create the game, and pass it the configuration
        var game = new Phaser.Game(800, 608, Phaser.AUTO, '', { preload: preload, create: create, update: update });

        function preload() {
            console.log("preload");
            
            this.load.image('barracks', 'assets/barracks.png');
            this.load.image('fort', 'assets/fort.png');
            this.load.image('button', 'assets/button.png');
            this.load.image('arrow', 'assets/arrow.png');
            this.load.image('navSquare', 'assets/navSquare.png');




            this.load.spritesheet('swordsman', 'assets/swordsman.png', 64, 64);
            this.load.spritesheet('swordswoman', 'assets/swordswoman.png', 64, 64);
            this.load.spritesheet('archer_male', 'assets/archer_male.png', 64, 64);
            this.load.spritesheet('archer_female', 'assets/archer_female.png', 64, 64);
            this.load.spritesheet('worker_male', 'assets/worker_male.png', 64, 64);
            this.load.spritesheet('worker_female', 'assets/worker_female.png', 64, 64);


            };

        function create() {
            this.navigator = new Navigator(this, 25, 19, 32);
  
    
            game.canvas.oncontextmenu = function (e) { e.preventDefault();return false;}   
            let barracks = new Barracks(0, 0, this);
            let fort = new Fort(320, 320, this);
            for(let i = 0; i < 4; i++)
            {
                for(let j = 0; j < 4; j++)
                {
                    this.navigator.navmap[i + Math.floor(320/32)][j + Math.floor(320/32)] = 1;
                }
            }


            this.objects = [];
            let button = {};
            button.button = true;
            button.update = () =>{};
            button.movable = false;
            button.sprite = this.add.sprite(200, 500, 'button');
            button.sprite.inputEnabled = true;
            button.sprite.events.onInputDown.add(function(){
            if(!this.selected.movable)
            {  
                if(this.selected.type == "Barracks")
                {
                    this.selected.buildSoldier();
                }

                if(this.selected.type == "Fort")
                {
                    this.selected.buildWorker();
                }
            } else {
                if(this.selected.type == "Worker")
                {
                    this.selected.build(100, 100, "Fort");
                }
            }
        }, this);
           
            this.objects.push(button);

            this.objects.push(barracks);

            this.objects.push(fort);

            game.input.mouse.capture = true;
        }


        function update(){

            if(game.input.activePointer.leftButton.isDown)
            {   
                //console.log(game.input.activePointer.x + "," + game.input.activePointer.y + " " + this.getSquare(game.input.activePointer.x, game.input.activePointer.y));
                this.navigator.getSquare(game.input.activePointer.x, game.input.activePointer.y);
                if(this.selected.movable)
                    {
                        if(Math.abs(game.input.activePointer.x - this.selected.sprite.x) > 64 || Math.abs(game.input.activePointer.y - this.selected.sprite.y)  > 64)
                        {
                            console.log(this.selected.placing)
                            if(this.selected.placing == true)
                            {
                                console.log("Placing!");
                                this.selected.place(game.input.x - 64, game.input.y -64);
                                return; 
                            }
                            //this.navigator.findNextNode(this.selected ,this.navigator.getSquare(game.input.activePointer.x, game.input.activePointer.y));
                            this.selected.move(game.input.activePointer.x, game.input.activePointer.y);
                        } 

                    }
                

            }
            this.objects.forEach(function(object){
                object.update();
            });
        }




  
    </script>

</body>
</html>